<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinical Amsler Grid</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3004/3004458.png">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="screen-reg" class="screen active card">
        <h1>Patient Intake</h1>
        <div class="subtitle">Clinical Amsler Assessment</div>

        <div class="input-group">
            <span class="label-title">Patient Name / ID</span>
            <input type="text" id="pName" placeholder="Name">
        </div>
        <div class="input-group">
            <span class="label-title">Age</span>
            <input type="number" id="pAge" placeholder="e.g. 55">
        </div>
        <div class="input-group">
            <span class="label-title">Gender</span>
            <div class="chip-container" id="grpGender">
                <div class="chip" onclick="selectSingle('grpGender', this)">Male</div>
                <div class="chip" onclick="selectSingle('grpGender', this)">Female</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label-title">Device Used</span>
            <div class="chip-container" id="grpDevice">
                <div class="chip selected" data-type="smartphone" onclick="selectSingle('grpDevice', this)">Smartphone</div>
                <div class="chip" data-type="laptop" onclick="selectSingle('grpDevice', this)">Laptop / PC</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label-title">Medical History</span>
            <div class="chip-container" id="grpMeds">
                <div class="chip" onclick="toggleMulti(this)">Diabetes</div>
                <div class="chip" onclick="toggleMulti(this)">Hypertension</div>
                <div class="chip" onclick="toggleMulti(this)">AMD</div>
                <div class="chip" onclick="toggleMulti(this)">Glaucoma</div>
                <div class="chip" onclick="toggleMulti(this)">None</div>
            </div>
        </div>

        <button class="btn" onclick="gotoCalibration()">
            Next: Calibration <span class="material-icons">arrow_forward</span>
        </button>
    </div>

    <div id="screen-calib" class="screen card">
        <button class="btn-small-back" onclick="goBackReg()">
            <span class="material-icons" style="font-size:1rem;">arrow_back</span> Back
        </button>
        <h1>Calibration</h1>
        <p id="calib-instruct">Match blue box to Credit Card.</p>
        
        <div class="calib-container">
            <div id="calibBox" class="calib-box">CREDIT CARD<br>8.56 cm</div>
        </div>
        
        <input type="range" id="calibSlider" min="100" max="800" value="300" oninput="updateCalibBox(this.value)">
        <button class="btn btn-accent" onclick="finishCalibration()">Confirm & Start</button>
    </div>

    <div id="screen-grid" class="screen card" style="max-width:800px;">
        <div class="grid-header">
            <button class="btn-header btn-header-clear" onclick="resetGrid()">
                <span class="material-icons">delete</span> Clear
            </button>
            <button id="btn-main-action" class="btn-header btn-header-save" onclick="handleMainAction()">
                SAVE OD <span class="material-icons">arrow_forward</span>
            </button>
        </div>

        <span class="current-eye-tag" id="dispEye">RIGHT EYE (OD)</span>
        <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Check fixation periodically.</div>

        <div class="pen-toolbar">
            <div class="pen-tool t-distort active" onclick="setPen('distort', this)">
                <span class="material-icons">waves</span> Distortion (Red)
            </div>
            <div class="pen-tool t-scotoma" onclick="setPen('scotoma', this)">
                <span class="material-icons">brush</span> Scotoma Fill (Black)
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="amslerCanvas"></canvas>
        </div>
    </div>

    <div id="screen-preview" class="screen card" style="max-width:800px;">
        <h1>Report Ready</h1>
        <p>Clinical report generated successfully.</p>
        <button class="btn btn-accent" onclick="downloadPDF()">
            <span class="material-icons">download</span> Download PDF
        </button>
        <button class="btn btn-outline" onclick="location.reload()">Start New Patient</button>
    </div>

    <div id="modal-fixation" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#f39c12">Fixation Check</h3>
            <p>Are you still looking at the <strong>Center Dot</strong>?</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-accent" onclick="confirmFixation(true)">Yes</button>
                <button class="btn btn-outline" onclick="confirmFixation(false)">No</button>
            </div>
        </div>
    </div>

    <div id="report-container">
        <div class="rep-head-block">
            <div class="rep-title">Detailed Amsler Grid Report</div>
            <div class="rep-sub">Ophthalmology & Optometry Clinical Record</div>
        </div>

        <table class="rep-table-info">
            <tr>
                <td class="rep-label">Name:</td><td id="repName"></td>
                <td class="rep-label">ID/MRN:</td><td id="repID"></td>
            </tr>
            <tr>
                <td class="rep-label">Date:</td><td id="repDate"></td>
                <td class="rep-label">Age/Sex:</td><td id="repDemo"></td>
            </tr>
            <tr>
                <td class="rep-label">Test Type:</td><td>Digital Amsler</td>
                <td class="rep-label">Device:</td><td id="repDevice"></td>
            </tr>
            <tr>
                <td class="rep-label">History:</td><td colspan="3" id="repHistory"></td>
            </tr>
        </table>

        <div class="rep-cols-2">
            <div class="rep-col">
                <div class="rep-section-title">RIGHT EYE (OD)</div>
                <div class="rep-img-container"><img id="imgOD" src=""></div>
                
                <div style="font-size:11px; margin-bottom:5px;"><strong>3. Classification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Normal (Negative)</th><td id="od_norm"></td></tr>
                    <tr><th class="left">Abnormal (Positive)</th><td id="od_abn"></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>4. Severity Grading</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Grade</th><td><span id="od_severity">-</span></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>7. Grid Quantification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Squares Affected</th><td><span id="od_sq">0</span> / 400</td></tr>
                    <tr><th class="left">% Involved</th><td><span id="od_pct">0</span>%</td></tr>
                    <tr><th class="left">Reliability</th><td><span id="od_rel">-</span></td></tr>
                </table>
            </div>

            <div class="rep-col">
                <div class="rep-section-title">LEFT EYE (OS)</div>
                <div class="rep-img-container"><img id="imgOS" src=""></div>
                
                <div style="font-size:11px; margin-bottom:5px;"><strong>3. Classification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Normal (Negative)</th><td id="os_norm"></td></tr>
                    <tr><th class="left">Abnormal (Positive)</th><td id="os_abn"></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>4. Severity Grading</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Grade</th><td><span id="os_severity">-</span></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>7. Grid Quantification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Squares Affected</th><td><span id="os_sq">0</span> / 400</td></tr>
                    <tr><th class="left">% Involved</th><td><span id="os_pct">0</span>%</td></tr>
                    <tr><th class="left">Reliability</th><td><span id="os_rel">-</span></td></tr>
                </table>
            </div>
        </div>

        <div class="rep-section-title">6. Quadrant Scoring (0-4 Scale)</div>
        <p style="font-size:10px; margin:0 0 5px 0;">Scale: 0=Normal, 1=Mild (<10%), 2=Mod (10-25%), 3=Severe (>25%), 4=Central Fixation Involved</p>
        <table class="rep-data-table">
            <tr>
                <th>Eye</th>
                <th>Sup-Temp</th><th>Sup-Nasal</th><th>Inf-Temp</th><th>Inf-Nasal</th>
                <th>Total Score</th>
            </tr>
            <tr>
                <td><strong>OD</strong></td>
                <td><span id="od_qs_st">0</span></td><td><span id="od_qs_sn">0</span></td>
                <td><span id="od_qs_it">0</span></td><td><span id="od_qs_in">0</span></td>
                <td><span id="od_qs_tot">0</span> / 16</td>
            </tr>
            <tr>
                <td><strong>OS</strong></td>
                <td><span id="os_qs_st">0</span></td><td><span id="os_qs_sn">0</span></td>
                <td><span id="os_qs_it">0</span></td><td><span id="os_qs_in">0</span></td>
                <td><span id="os_qs_tot">0</span> / 16</td>
            </tr>
        </table>

        <div class="rep-section-title">9. Clinical Impression / Recommendations</div>
        <div style="border:1px solid #999; height: 60px; margin-bottom: 20px;"></div>
        
        <div style="font-size:12px;">
            <strong>Clinician Signature:</strong> ____________________________________ &nbsp;&nbsp;&nbsp; 
            <strong>Date:</strong> _______________
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Register PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(() => console.log('Service Worker Registered'))
            .catch((error) => console.log('Service Worker Fail:', error));
        }
    </script>
</body>
</html>