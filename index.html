<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clinical Amsler V27</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg-light: #ecf0f1;
            --white: #ffffff;
            --success: #27ae60;
            --danger: #c0392b;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-light);
            color: #2c3e50;
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            touch-action: pan-y;
        }

        /* --- SCREEN VISIBILITY --- */
        .screen { display: none; width: 100%; max-width: 600px; }
        .screen.active { display: block; }

        .card {
            background: var(--white);
            padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px; text-align: center;
            position: relative;
        }

        h1 { margin: 0 0 5px 0; color: var(--primary); font-size: 1.5rem; }
        .subtitle { color: #7f8c8d; font-size: 0.9rem; margin-bottom: 20px; }

        /* --- FORM ELEMENTS --- */
        .input-group { text-align: left; margin-bottom: 15px; }
        .label-title { font-weight: bold; font-size: 0.85rem; color: #7f8c8d; display: block; margin-bottom: 5px; }
        
        input[type="text"], input[type="number"] {
            width: 100%; padding: 12px; border: 2px solid #bdc3c7; border-radius: 8px;
            font-size: 1rem; box-sizing: border-box;
        }

        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            padding: 8px 15px; border: 2px solid #bdc3c7; border-radius: 20px;
            font-size: 0.9rem; font-weight: 600; color: #7f8c8d; cursor: pointer;
            flex-grow: 1; text-align: center; user-select: none;
        }
        .chip.selected { background: #d6eaf8; border-color: var(--accent); color: var(--accent); }

        /* BUTTONS */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 10px;
            background: var(--primary); color: white; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-header { padding: 8px 15px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px; border: none; }
        .btn-header-clear { background: #ffebee; color: var(--danger); }
        .btn-header-save { background: var(--success); color: white; }
        .btn-header-report { background: var(--accent); color: white; }
        .btn-small-back { position: absolute; top: 15px; left: 15px; background: transparent; border: none; color: #7f8c8d; cursor: pointer; font-weight: bold; display: flex; align-items: center; }
        .btn-outline { background: transparent; border: 1px solid #bdc3c7; color: var(--primary); }
        .btn-accent { background: var(--accent); }

        /* GRID HEADER */
        .grid-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .current-eye-tag { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 5px; display: block; }

        /* CALIBRATION */
        .calib-container { height: 350px; width: 100%; display: flex; justify-content: center; align-items: center; background: #f8f9fa; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .calib-box { background: var(--accent); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        input[type=range] { width: 100%; margin: 15px 0; }

        /* PENS */
        .pen-toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
        .pen-tool { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-weight: bold; font-size: 0.8rem; cursor: pointer; opacity: 0.6; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .pen-tool.active { opacity: 1; border-width: 3px; transform: scale(1.02); }
        .t-distort { color: #c0392b; border-color: #c0392b; background: #fceceb; }
        .t-scotoma { color: #2c3e50; border-color: #2c3e50; background: #ebedef; }

        .canvas-wrapper { position: relative; border: 4px solid #333; margin: 0 auto 15px auto; cursor: crosshair; background: white; touch-action: none; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; text-align: center; }

        /* --- PDF REPORT STYLES (A4 Optimized) --- */
        #report-container {
            display: none; 
            background: white; 
            width: 750px; /* Fits nicely in A4 pdf conversion */
            padding: 30px; 
            text-align: left;
            font-family: 'Times New Roman', serif; 
            color: #000;
            box-sizing: border-box;
            border: 1px solid white; /* Prevent bleeding */
        }

        .rep-head-block { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
        .rep-title { font-size: 20px; font-weight: bold; text-transform: uppercase; }
        .rep-sub { font-size: 14px; margin-bottom: 10px; }
        
        .rep-table-info { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 12px; }
        .rep-table-info td { padding: 4px; vertical-align: top; }
        .rep-label { font-weight: bold; width: 120px; }

        .rep-section-title { 
            background: #eee; font-weight: bold; font-size: 13px; 
            padding: 5px; margin-top: 15px; margin-bottom: 5px; border-left: 4px solid #333; 
        }

        .rep-cols-2 { display: flex; gap: 20px; width: 100%; }
        .rep-col { flex: 1; }

        .rep-data-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 5px; }
        .rep-data-table th, .rep-data-table td { border: 1px solid #999; padding: 4px; text-align: center; }
        .rep-data-table th { background: #f0f0f0; text-align: left; }
        .rep-data-table td.left { text-align: left; }

        .rep-img-container {
            border: 1px solid #ccc; height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 5px;
        }
        .rep-img-container img { max-height: 190px; max-width: 95%; }

        /* Checkbox simulation */
        .cb { display: inline-block; width: 10px; height: 10px; border: 1px solid #000; margin-right: 5px; }
        .cb.checked { background: #000; }

    </style>
</head>
<body>

    <div id="screen-reg" class="screen active card">
        <h1>Patient Intake</h1>
        <div class="subtitle">Clinical Amsler Assessment</div>

        <div class="input-group">
            <span class="label-title">Patient Name / ID</span>
            <input type="text" id="pName" placeholder="Name">
        </div>
        <div class="input-group">
            <span class="label-title">Age</span>
            <input type="number" id="pAge" placeholder="e.g. 55">
        </div>
        <div class="input-group">
            <span class="label-title">Gender</span>
            <div class="chip-container" id="grpGender">
                <div class="chip" onclick="selectSingle('grpGender', this)">Male</div>
                <div class="chip" onclick="selectSingle('grpGender', this)">Female</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label-title">Device Used</span>
            <div class="chip-container" id="grpDevice">
                <div class="chip selected" data-type="smartphone" onclick="selectSingle('grpDevice', this)">Smartphone</div>
                <div class="chip" data-type="laptop" onclick="selectSingle('grpDevice', this)">Laptop / PC</div>
            </div>
        </div>
        <div class="input-group">
            <span class="label-title">Medical History</span>
            <div class="chip-container" id="grpMeds">
                <div class="chip" onclick="toggleMulti(this)">Diabetes</div>
                <div class="chip" onclick="toggleMulti(this)">Hypertension</div>
                <div class="chip" onclick="toggleMulti(this)">AMD</div>
                <div class="chip" onclick="toggleMulti(this)">Glaucoma</div>
                <div class="chip" onclick="toggleMulti(this)">None</div>
            </div>
        </div>

        <button class="btn" onclick="gotoCalibration()">
            Next: Calibration <span class="material-icons">arrow_forward</span>
        </button>
    </div>

    <div id="screen-calib" class="screen card">
        <button class="btn-small-back" onclick="goBackReg()">
            <span class="material-icons" style="font-size:1rem;">arrow_back</span> Back
        </button>
        <h1>Calibration</h1>
        <p id="calib-instruct">Match blue box to Credit Card (8.56cm).</p>
        <div class="calib-container"><div id="calibBox" class="calib-box">CREDIT CARD<br>8.56 cm</div></div>
        <input type="range" id="calibSlider" min="100" max="800" value="300" oninput="updateCalibBox(this.value)">
        <button class="btn btn-accent" onclick="finishCalibration()">Confirm & Start</button>
    </div>

    <div id="screen-grid" class="screen card" style="max-width:800px;">
        <div class="grid-header">
            <button class="btn-header btn-header-clear" onclick="resetGrid()">
                <span class="material-icons">delete</span> Clear
            </button>
            <button id="btn-main-action" class="btn-header btn-header-save" onclick="handleMainAction()">
                SAVE OD <span class="material-icons">arrow_forward</span>
            </button>
        </div>

        <span class="current-eye-tag" id="dispEye">RIGHT EYE (OD)</span>
        <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">Check fixation periodically.</div>

        <div class="pen-toolbar">
            <div class="pen-tool t-distort active" onclick="setPen('distort', this)">
                <span class="material-icons">waves</span> Distortion (Red)
            </div>
            <div class="pen-tool t-scotoma" onclick="setPen('scotoma', this)">
                <span class="material-icons">brush</span> Scotoma Fill (Black)
            </div>
        </div>

        <div class="canvas-wrapper">
            <canvas id="amslerCanvas"></canvas>
        </div>
    </div>

    <div id="screen-preview" class="screen card" style="max-width:800px;">
        <h1>Report Ready</h1>
        <p>Clinical report generated successfully.</p>
        <button class="btn btn-accent" onclick="downloadPDF()">
            <span class="material-icons">download</span> Download PDF
        </button>
        <button class="btn btn-outline" onclick="location.reload()">Start New Patient</button>
    </div>

    <div id="modal-fixation" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:#f39c12">Fixation Check</h3>
            <p>Are you still looking at the <strong>Center Dot</strong>?</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-accent" onclick="confirmFixation(true)">Yes</button>
                <button class="btn btn-outline" onclick="confirmFixation(false)">No</button>
            </div>
        </div>
    </div>

    <div id="report-container">
        <div class="rep-head-block">
            <div class="rep-title">Detailed Amsler Grid Report</div>
            <div class="rep-sub">Ophthalmology & Optometry Clinical Record</div>
        </div>

        <table class="rep-table-info">
            <tr>
                <td class="rep-label">Name:</td><td id="repName"></td>
                <td class="rep-label">ID/MRN:</td><td id="repID"></td>
            </tr>
            <tr>
                <td class="rep-label">Date:</td><td id="repDate"></td>
                <td class="rep-label">Age/Sex:</td><td id="repDemo"></td>
            </tr>
            <tr>
                <td class="rep-label">Test Type:</td><td>Digital Amsler</td>
                <td class="rep-label">Device:</td><td id="repDevice"></td>
            </tr>
            <tr>
                <td class="rep-label">History:</td><td colspan="3" id="repHistory"></td>
            </tr>
        </table>

        <div class="rep-cols-2">
            <div class="rep-col">
                <div class="rep-section-title">RIGHT EYE (OD)</div>
                <div class="rep-img-container"><img id="imgOD" src=""></div>
                
                <div style="font-size:11px; margin-bottom:5px;"><strong>3. Classification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Normal (Negative)</th><td id="od_norm"></td></tr>
                    <tr><th class="left">Abnormal (Positive)</th><td id="od_abn"></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>4. Severity Grading</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Grade</th><td><span id="od_severity">-</span></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>7. Grid Quantification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Squares Affected</th><td><span id="od_sq">0</span> / 400</td></tr>
                    <tr><th class="left">% Involved</th><td><span id="od_pct">0</span>%</td></tr>
                    <tr><th class="left">Reliability</th><td><span id="od_rel">-</span></td></tr>
                </table>
            </div>

            <div class="rep-col">
                <div class="rep-section-title">LEFT EYE (OS)</div>
                <div class="rep-img-container"><img id="imgOS" src=""></div>
                
                <div style="font-size:11px; margin-bottom:5px;"><strong>3. Classification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Normal (Negative)</th><td id="os_norm"></td></tr>
                    <tr><th class="left">Abnormal (Positive)</th><td id="os_abn"></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>4. Severity Grading</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Grade</th><td><span id="os_severity">-</span></td></tr>
                </table>

                <div style="font-size:11px; margin-bottom:5px;"><strong>7. Grid Quantification</strong></div>
                <table class="rep-data-table">
                    <tr><th class="left">Squares Affected</th><td><span id="os_sq">0</span> / 400</td></tr>
                    <tr><th class="left">% Involved</th><td><span id="os_pct">0</span>%</td></tr>
                    <tr><th class="left">Reliability</th><td><span id="os_rel">-</span></td></tr>
                </table>
            </div>
        </div>

        <div class="rep-section-title">6. Quadrant Scoring (0-4 Scale)</div>
        <p style="font-size:10px; margin:0 0 5px 0;">Scale: 0=Normal, 1=Mild (<10%), 2=Mod (10-25%), 3=Severe (>25%), 4=Central Fixation Involved</p>
        <table class="rep-data-table">
            <tr>
                <th>Eye</th>
                <th>Sup-Temp</th><th>Sup-Nasal</th><th>Inf-Temp</th><th>Inf-Nasal</th>
                <th>Total Score</th>
            </tr>
            <tr>
                <td><strong>OD</strong></td>
                <td><span id="od_qs_st">0</span></td><td><span id="od_qs_sn">0</span></td>
                <td><span id="od_qs_it">0</span></td><td><span id="od_qs_in">0</span></td>
                <td><span id="od_qs_tot">0</span> / 16</td>
            </tr>
            <tr>
                <td><strong>OS</strong></td>
                <td><span id="os_qs_st">0</span></td><td><span id="os_qs_sn">0</span></td>
                <td><span id="os_qs_it">0</span></td><td><span id="os_qs_in">0</span></td>
                <td><span id="os_qs_tot">0</span> / 16</td>
            </tr>
        </table>

        <div class="rep-section-title">9. Clinical Impression / Recommendations</div>
        <div style="border:1px solid #999; height: 60px; margin-bottom: 20px;"></div>
        
        <div style="font-size:12px;">
            <strong>Clinician Signature:</strong> ____________________________________ &nbsp;&nbsp;&nbsp; 
            <strong>Date:</strong> _______________
        </div>
    </div>

<script>
    // --- STATE ---
    let patient = {};
    let currentEye = "OD";
    
    // Tech Config
    const STD_CARD_CM = 8.56;
    let pxPerCm = 0;
    let gridSizePx = 0;
    const GRID_DIM = 20; 
    let gridData = [];   

    // Results Storage
    let results = { OD: null, OS: null };

    // Tools
    let fixCheck = 0; let fixLoss = 0; let fixTimer = null;
    let isDrawing = false; let activePen = 'distort'; 
    let currentPath = []; // For Fill logic

    const canvas = document.getElementById('amslerCanvas');
    const ctx = canvas.getContext('2d');

    // --- NAVIGATION ---
    function goBackReg() { document.getElementById('screen-calib').classList.remove('active'); document.getElementById('screen-reg').classList.add('active'); }
    function selectSingle(gid, el) { document.querySelectorAll(`#${gid} .chip`).forEach(c => c.classList.remove('selected')); el.classList.add('selected'); }
    
    function toggleMulti(el) {
        if(el.innerText==="None"){ el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('selected')); el.classList.add('selected'); }
        else { 
            const none = Array.from(el.parentElement.children).find(c=>c.innerText==="None");
            if(none) none.classList.remove('selected');
            el.classList.toggle('selected');
        }
    }
    
    function setPen(type, el) {
        activePen = type;
        document.querySelectorAll('.pen-tool').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
    }

    // --- SETUP ---
    function gotoCalibration() {
        const name = document.getElementById('pName').value;
        const age = document.getElementById('pAge').value;
        const genEl = document.querySelector('#grpGender .selected');
        const devEl = document.querySelector('#grpDevice .selected');
        
        if(!name || !age || !genEl || !devEl) return alert("Please complete details");

        let meds = [];
        document.querySelectorAll('#grpMeds .selected').forEach(c=>meds.push(c.innerText));

        patient = { name, age, gender: genEl.innerText, history: meds.join(", "), device: devEl.getAttribute('data-type') };
        setupCalibrationUI();
        document.getElementById('screen-reg').classList.remove('active');
        document.getElementById('screen-calib').classList.add('active');
    }

    function setupCalibrationUI() {
        const box = document.getElementById('calibBox');
        const instruct = document.getElementById('calib-instruct');
        const slider = document.getElementById('calibSlider');
        if (patient.device === 'smartphone') {
            instruct.innerHTML = "Rotate card <strong>VERTICALLY</strong>. Match box <strong>HEIGHT</strong>.";
            box.style.width = "150px"; 
            updateCalibBox(400); slider.value = 400;
        } else {
            instruct.innerHTML = "Place card <strong>HORIZONTALLY</strong>. Match box <strong>WIDTH</strong>.";
            box.style.height = "150px";
            updateCalibBox(300); slider.value = 300;
        }
    }

    function updateCalibBox(val) { 
        const box = document.getElementById('calibBox');
        if(patient.device === 'smartphone') box.style.height = val + "px"; else box.style.width = val + "px";
    }
    
    function finishCalibration() {
        const val = document.getElementById('calibSlider').value;
        pxPerCm = val / STD_CARD_CM;
        const dist = patient.device === 'smartphone' ? 30 : 50;
        gridSizePx = (2 * dist * Math.tan(10 * Math.PI/180)) * pxPerCm;
        
        canvas.width = gridSizePx; canvas.height = gridSizePx;
        resetGrid();

        document.getElementById('screen-calib').classList.remove('active');
        document.getElementById('screen-grid').classList.add('active');
        startFixation();
    }

    // --- GRID ENGINE ---
    function resetGrid() {
        gridData = Array(GRID_DIM).fill().map(() => Array(GRID_DIM).fill(null));
        drawBaseGrid();
    }
    
    function drawBaseGrid() {
        ctx.fillStyle="white"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.strokeStyle="black"; ctx.lineWidth=1;
        ctx.beginPath();
        const step = gridSizePx / GRID_DIM;
        for(let i=0; i<=gridSizePx; i+=step){ ctx.moveTo(i,0); ctx.lineTo(i,gridSizePx); ctx.moveTo(0,i); ctx.lineTo(gridSizePx,i); }
        ctx.stroke();
        ctx.fillStyle="black"; ctx.beginPath(); ctx.arc(gridSizePx/2, gridSizePx/2, gridSizePx*0.015, 0, Math.PI*2); ctx.fill();
    }

    // --- DRAWING & FILL LOGIC ---
    function getPos(e) {
        const r = canvas.getBoundingClientRect();
        const cx = e.touches?e.touches[0].clientX:e.clientX;
        const cy = e.touches?e.touches[0].clientY:e.clientY;
        return { x: cx - r.left, y: cy - r.top };
    }

    function startDraw(e) {
        if(e.cancelable) e.preventDefault();
        isDrawing = true;
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        
        if (activePen === 'distort') {
            ctx.fillStyle = "rgba(231, 76, 60, 0.5)"; 
            ctx.fillRect(pos.x, pos.y, 2, 2);
            captureData(pos.x, pos.y); // Log point
        } else {
            // SCOTOMA: Start recording path for fill
            currentPath = [{x:pos.x, y:pos.y}];
        }
    }

    function draw(e) {
        if(!isDrawing) return;
        if(e.cancelable) e.preventDefault();
        const pos = getPos(e);

        ctx.lineWidth = activePen==='scotoma' ? 3 : 4;
        ctx.lineCap = "round"; ctx.lineJoin = "round";
        
        if (activePen === 'distort') {
            ctx.strokeStyle = "rgba(231, 76, 60, 0.5)";
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
            captureData(pos.x, pos.y);
        } else {
            // SCOTOMA: Draw outline visual
            ctx.strokeStyle = "rgba(44, 62, 80, 1)";
            ctx.lineTo(pos.x, pos.y); ctx.stroke();
            currentPath.push({x:pos.x, y:pos.y});
        }
    }

    function stopDraw() {
        if(isDrawing && activePen === 'scotoma' && currentPath.length > 2) {
            // AUTO FILL LOGIC
            ctx.beginPath();
            ctx.moveTo(currentPath[0].x, currentPath[0].y);
            for(let p of currentPath) ctx.lineTo(p.x, p.y);
            ctx.closePath();
            ctx.fillStyle = "black";
            ctx.fill();
            
            // MATH: Check which squares are inside this shape
            updateGridDataForPoly();
        }
        isDrawing=false; ctx.beginPath(); 
    }

    canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('touchstart', startDraw, {passive:false}); canvas.addEventListener('touchmove', draw, {passive:false}); canvas.addEventListener('touchend', stopDraw);

    // Capture point for Red Pen
    function captureData(x, y) {
        const step = gridSizePx / GRID_DIM;
        const c = Math.floor(x/step); const r = Math.floor(y/step);
        if(c>=0 && c<GRID_DIM && r>=0 && r<GRID_DIM) gridData[r][c] = 'distort';
    }

    // Capture area for Black Pen Fill
    function updateGridDataForPoly() {
        const step = gridSizePx / GRID_DIM;
        // Simple hit test for every square center
        for(let r=0; r<GRID_DIM; r++){
            for(let c=0; c<GRID_DIM; c++){
                let cx = (c*step) + (step/2);
                let cy = (r*step) + (step/2);
                if(ctx.isPointInPath(cx, cy)) {
                    gridData[r][c] = 'scotoma';
                }
            }
        }
    }

    // --- MAIN ACTION ---
    function handleMainAction() {
        const btn = document.getElementById('btn-main-action');
        if (currentEye === 'OD') {
            saveEye('OD');
            currentEye = 'OS';
            document.getElementById('dispEye').innerText = "LEFT EYE (OS)";
            btn.innerHTML = 'SAVE OS & FINISH <span class="material-icons">check</span>';
            resetGrid();
            alert("Right Eye Saved. Switch to LEFT EYE.");
        } else if (currentEye === 'OS') {
            saveEye('OS');
            clearTimeout(fixTimer); // STOP TIMER
            generateReportData();
            document.getElementById('screen-grid').classList.remove('active');
            document.getElementById('screen-preview').classList.add('active');
        }
    }

    function saveEye(eye) {
        results[eye] = {
            img: canvas.toDataURL("image/png"),
            stats: calculateStats(gridData),
            reliability: fixCheck>0 ? Math.round(((fixCheck-fixLoss)/fixCheck)*100)+"%" : "N/A"
        };
        fixCheck=0; fixLoss=0;
    }

    function calculateStats(data) {
        let s = { dist:0, scot:0, total:0, scores:{TL:0, TR:0, BL:0, BR:0}, qCount:{TL:0, TR:0, BL:0, BR:0} };
        const centerIdx = [9, 10]; 

        for(let r=0; r<GRID_DIM; r++){
            for(let c=0; c<GRID_DIM; c++){
                if(data[r][c] !== null){
                    s.total++;
                    if(data[r][c]==='distort') s.dist++; else s.scot++;
                    let quad = '';
                    if(r<10 && c<10) quad='TL';
                    else if(r<10 && c>=10) quad='TR';
                    else if(r>=10 && c<10) quad='BL';
                    else quad='BR';
                    
                    s.qCount[quad]++;
                    if(centerIdx.includes(r) && centerIdx.includes(c)) s.scores[quad] = 4;
                }
            }
        }
        ['TL','TR','BL','BR'].forEach(q => {
            if(s.scores[q] !== 4) {
                const count = s.qCount[q];
                if(count === 0) s.scores[q]=0;
                else if(count <= 10) s.scores[q]=1; 
                else if(count <= 25) s.scores[q]=2; 
                else s.scores[q]=3; 
            }
        });
        return s;
    }

    // --- FIXATION ---
    function startFixation() {
        clearTimeout(fixTimer);
        const t = Math.random()*(25000-15000)+15000;
        fixTimer = setTimeout(()=>{ document.getElementById('modal-fixation').style.display='flex'; }, t);
    }
    function confirmFixation(ok) {
        fixCheck++; if(!ok) fixLoss++;
        document.getElementById('modal-fixation').style.display='none';
        startFixation();
    }

    // --- PDF LOGIC ---
    function generateReportData() {
        const d = new Date();
        document.getElementById('repDate').innerText = d.toLocaleDateString();
        document.getElementById('repName').innerText = patient.name;
        document.getElementById('repID').innerText = "MRN-"+Math.floor(Math.random()*10000);
        document.getElementById('repDemo').innerText = `${patient.age} / ${patient.gender}`;
        document.getElementById('repHistory').innerText = patient.history;
        document.getElementById('repDevice').innerText = patient.device.toUpperCase();
        
        ['OD','OS'].forEach(eye => {
            const r = results[eye];
            if(r) {
                document.getElementById('img'+eye).src = r.img;
                
                // Classify
                const isAbnormal = r.stats.total > 0;
                document.getElementById(eye.toLowerCase()+'_norm').innerHTML = isAbnormal ? '<span class="cb"></span>' : '<span class="cb checked"></span>';
                document.getElementById(eye.toLowerCase()+'_abn').innerHTML = isAbnormal ? '<span class="cb checked"></span>' : '<span class="cb"></span>';

                // Severity Text
                const totalScore = r.stats.scores.TL + r.stats.scores.TR + r.stats.scores.BL + r.stats.scores.BR;
                let sev = "Normal";
                if(totalScore > 0) sev = "Mild";
                if(totalScore > 4) sev = "Moderate";
                if(totalScore > 8) sev = "Severe";
                if(r.stats.scores.TL===4 || r.stats.scores.TR===4 || r.stats.scores.BL===4 || r.stats.scores.BR===4) sev = "Severe (Central)";
                document.getElementById(eye.toLowerCase()+'_severity').innerText = sev;

                // Quant
                document.getElementById(eye.toLowerCase()+'_sq').innerText = r.stats.total;
                document.getElementById(eye.toLowerCase()+'_pct').innerText = ((r.stats.total/400)*100).toFixed(1);
                document.getElementById(eye.toLowerCase()+'_rel').innerText = r.reliability;

                // Quadrants
                document.getElementById(eye.toLowerCase()+'_qs_st').innerText = r.stats.scores.TL;
                document.getElementById(eye.toLowerCase()+'_qs_sn').innerText = r.stats.scores.TR;
                document.getElementById(eye.toLowerCase()+'_qs_it').innerText = r.stats.scores.BL;
                document.getElementById(eye.toLowerCase()+'_qs_in').innerText = r.stats.scores.BR;
                document.getElementById(eye.toLowerCase()+'_qs_tot').innerText = totalScore;
            }
        });
    }

    function downloadPDF() {
        const element = document.getElementById('report-container');
        element.style.display = 'block'; // Reveal for capture
        
        const opt = {
            margin:       [0.3, 0.3, 0.3, 0.3], // Small margins
            filename:     `Amsler_${patient.name}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none'; // Hide after
        });
    }
</script>
</body>
</html>
